{% extends 'marketing/base_marketing.html' %}

{% block title %}Assistant Vid√©o IA - Bolibana Studio{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    
    <!-- Header -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2">
                    üí° Assistant Vid√©o IA
                </h1>
                <p class="text-gray-600 dark:text-gray-400">
                    Laissez l'IA vous guider pour cr√©er votre vid√©o parfaite
                </p>
            </div>
            <button onclick="resetConversation()"
                    class="inline-flex items-center px-4 py-2 bg-gray-200 dark:bg-neutral-700 hover:bg-gray-300 dark:hover:bg-neutral-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Recommencer
            </button>
        </div>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
        
        <!-- Chat Interface -->
        <div class="lg:col-span-2">
            <div class="bg-white dark:bg-neutral-900 rounded-lg shadow-lg border border-gray-200 dark:border-neutral-800 overflow-hidden flex flex-col h-[calc(100vh-16rem)]">
                
                <!-- Messages container -->
                <div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-4">
                    
                    <!-- Welcome message -->
                    <div class="flex items-start space-x-3" id="welcome-message">
                        <div class="flex-shrink-0">
                            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-semibold shadow-md">
                                AI
                            </div>
                        </div>
                        <div class="flex-1 bg-gradient-to-br from-indigo-50 to-purple-50 dark:from-indigo-950/30 dark:to-purple-950/30 rounded-lg p-4 border border-indigo-200 dark:border-indigo-800">
                            <p class="text-gray-900 dark:text-white font-medium mb-2">üëã Bonjour ! Je suis votre assistant vid√©o IA.</p>
                            <p class="text-gray-700 dark:text-gray-300 text-sm mb-3">
                                Je vais vous aider √† cr√©er une vid√©o professionnelle √©tape par √©tape. 
                                Commencez par me dire :
                            </p>
                            <ul class="space-y-2 text-sm text-gray-700 dark:text-gray-300">
                                <li class="flex items-start">
                                    <span class="text-indigo-500 mr-2">1Ô∏è‚É£</span>
                                    <span>Quel est le sujet de votre vid√©o ?</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-indigo-500 mr-2">2Ô∏è‚É£</span>
                                    <span>Quel type de contenu ? (tutoriel, d√©mo, storytelling, tips...)</span>
                                </li>
                                <li class="flex items-start">
                                    <span class="text-indigo-500 mr-2">3Ô∏è‚É£</span>
                                    <span>Quelle plateforme ? (TikTok, YouTube, Instagram...)</span>
                                </li>
                            </ul>
                            <div class="mt-4 flex flex-wrap gap-2">
                                <button onclick="quickStart('Tutorial Python d√©butant')" 
                                        class="px-3 py-1.5 bg-white dark:bg-neutral-800 border border-indigo-300 dark:border-indigo-700 text-indigo-600 dark:text-indigo-400 text-xs font-medium rounded-md hover:bg-indigo-50 dark:hover:bg-indigo-950/50 transition-colors">
                                    üí° Tutorial Python
                                </button>
                                <button onclick="quickStart('D√©mo application Django')" 
                                        class="px-3 py-1.5 bg-white dark:bg-neutral-800 border border-purple-300 dark:border-purple-700 text-purple-600 dark:text-purple-400 text-xs font-medium rounded-md hover:bg-purple-50 dark:hover:bg-purple-950/50 transition-colors">
                                    üé¨ D√©mo App
                                </button>
                                <button onclick="quickStart('Tips d√©veloppement web')" 
                                        class="px-3 py-1.5 bg-white dark:bg-neutral-800 border border-pink-300 dark:border-pink-700 text-pink-600 dark:text-pink-400 text-xs font-medium rounded-md hover:bg-pink-50 dark:hover:bg-pink-950/50 transition-colors">
                                    ‚ö° Tips & Astuces
                                </button>
                            </div>
                        </div>
                    </div>

                </div>

                <!-- Input area -->
                <div class="border-t border-gray-200 dark:border-neutral-800 p-4 bg-gray-50 dark:bg-neutral-900/50">
                    <form id="chat-form" class="flex items-end gap-3">
                        <div class="flex-1">
                            <textarea id="user-input" 
                                      rows="2"
                                      placeholder="D√©crivez votre vid√©o, uploadez des assets, ou posez une question..." 
                                      class="w-full px-4 py-3 border border-gray-300 dark:border-neutral-700 rounded-lg bg-white dark:bg-neutral-800 text-gray-900 dark:text-white placeholder-gray-500 dark:placeholder-gray-400 focus:ring-2 focus:ring-indigo-500 focus:border-transparent resize-none"
                                      maxlength="1000"></textarea>
                            <div class="mt-2 flex items-center justify-between">
                                <div class="flex items-center gap-2">
                                    <button type="button" 
                                            onclick="document.getElementById('asset-input').click()"
                                            class="inline-flex items-center px-3 py-1.5 text-xs font-medium text-gray-700 dark:text-gray-300 hover:text-indigo-600 dark:hover:text-indigo-400 transition-colors">
                                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
                                        </svg>
                                        Joindre fichiers
                                    </button>
                                    <input type="file" id="asset-input" multiple accept="image/*,video/*" class="hidden" onchange="handleAssetUpload(event)">
                                    <span id="file-count" class="text-xs text-gray-500 dark:text-gray-400 hidden"></span>
                                </div>
                                <span id="char-count" class="text-xs text-gray-500 dark:text-gray-400">0/1000</span>
                            </div>
                        </div>
                        <button type="submit" 
                                id="send-button"
                                class="px-6 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"/>
                            </svg>
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Project summary sidebar -->
        <div class="lg:col-span-1">
            <div class="bg-white dark:bg-neutral-900 rounded-lg shadow-lg border border-gray-200 dark:border-neutral-800 p-6 sticky top-24">
                <h3 class="text-lg font-bold text-gray-900 dark:text-white mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                    </svg>
                    R√©sum√© du Projet
                </h3>

                <div id="project-summary" class="space-y-4">
                    <div class="text-center py-8 text-gray-500 dark:text-gray-400">
                        <svg class="w-12 h-12 mx-auto mb-3 text-gray-400 dark:text-gray-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        <p class="text-sm">Les informations de votre projet appara√Ætront ici au fur et √† mesure.</p>
                    </div>
                </div>

                <!-- Action buttons (hidden initially) -->
                <div id="action-buttons" class="hidden mt-6 space-y-3">
                    <button onclick="generateJob()" 
                            class="w-full px-4 py-3 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white font-semibold rounded-lg shadow-md hover:shadow-lg transition-all duration-200">
                        <span class="flex items-center justify-center">
                            <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                            </svg>
                            G√©n√©rer la Vid√©o
                        </span>
                    </button>
                    <button onclick="editProject()" 
                            class="w-full px-4 py-2 bg-gray-200 dark:bg-neutral-700 hover:bg-gray-300 dark:hover:bg-neutral-600 text-gray-700 dark:text-gray-300 font-medium rounded-lg transition-colors">
                        Modifier
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// State management
let conversation = [];
let projectData = {
    title: '',
    theme: '',
    pillar: '',
    platform: '',
    segments: [],
    assets: [],
    provider: 'luma',
    aspectRatio: '9:16'
};
let uploadedAssets = [];

// DOM elements
const messagesContainer = document.getElementById('messages-container');
const chatForm = document.getElementById('chat-form');
const userInput = document.getElementById('user-input');
const sendButton = document.getElementById('send-button');
const charCount = document.getElementById('char-count');
const projectSummary = document.getElementById('project-summary');
const actionButtons = document.getElementById('action-buttons');

// Character counter
userInput.addEventListener('input', () => {
    charCount.textContent = `${userInput.value.length}/1000`;
});

// Enter to send (Shift+Enter for new line)
userInput.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
        e.preventDefault();
        chatForm.dispatchEvent(new Event('submit'));
    }
});

// Quick start
function quickStart(topic) {
    userInput.value = topic;
    chatForm.dispatchEvent(new Event('submit'));
}

// Handle asset upload
function handleAssetUpload(event) {
    const files = Array.from(event.target.files);
    uploadedAssets.push(...files);
    
    document.getElementById('file-count').textContent = `${uploadedAssets.length} fichier(s)`;
    document.getElementById('file-count').classList.remove('hidden');
    
    // Show preview in chat
    addMessage('user', `üìé ${files.length} fichier(s) ajout√©(s)`);
}

// Chat form submit
chatForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const message = userInput.value.trim();
    if (!message) return;
    
    // Add user message
    addMessage('user', message);
    userInput.value = '';
    charCount.textContent = '0/1000';
    
    // Show typing indicator
    const typingId = showTyping();
    
    try {
        // Send to backend
        const response = await fetch('{% url "marketing:ai_chat" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value || getCookie('csrftoken')
            },
            body: JSON.stringify({
                message: message,
                conversation: conversation,
                projectData: projectData,
                uploadedAssets: uploadedAssets.map(f => f.name)
            })
        });
        
        const data = await response.json();
        
        // Remove typing indicator
        removeTyping(typingId);
        
        // Add AI response
        addMessage('ai', data.response);
        
        // Update conversation
        conversation.push({ role: 'user', content: message });
        conversation.push({ role: 'assistant', content: data.response });
        
        // Update project data if provided
        if (data.projectUpdate) {
            updateProjectData(data.projectUpdate);
        }
        
    } catch (error) {
        removeTyping(typingId);
        addMessage('ai', '‚ùå D√©sol√©, une erreur s\'est produite. Pouvez-vous reformuler ?');
        console.error('Error:', error);
    }
});

// Add message to chat
function addMessage(sender, content) {
    const div = document.createElement('div');
    div.className = 'flex items-start space-x-3';
    
    if (sender === 'ai') {
        div.innerHTML = `
            <div class="flex-shrink-0">
                <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-semibold shadow-md">
                    AI
                </div>
            </div>
            <div class="flex-1 bg-gray-100 dark:bg-neutral-800 rounded-lg p-4">
                <p class="text-gray-900 dark:text-white whitespace-pre-wrap">${escapeHtml(content)}</p>
            </div>
        `;
    } else {
        div.innerHTML = `
            <div class="flex-1 flex justify-end">
                <div class="bg-gradient-to-r from-indigo-600 to-purple-600 text-white rounded-lg p-4 max-w-md">
                    <p class="whitespace-pre-wrap">${escapeHtml(content)}</p>
                </div>
            </div>
            <div class="flex-shrink-0">
                <div class="w-10 h-10 rounded-full bg-gray-300 dark:bg-neutral-700 flex items-center justify-center text-gray-700 dark:text-gray-300 font-semibold">
                    {{ user.username|slice:":1"|upper|default:"U" }}
                </div>
            </div>
        `;
    }
    
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
}

// Show typing indicator
function showTyping() {
    const id = 'typing-' + Date.now();
    const div = document.createElement('div');
    div.id = id;
    div.className = 'flex items-start space-x-3';
    div.innerHTML = `
        <div class="flex-shrink-0">
            <div class="w-10 h-10 rounded-full bg-gradient-to-br from-indigo-500 to-purple-500 flex items-center justify-center text-white font-semibold shadow-md">
                AI
            </div>
        </div>
        <div class="flex-1 bg-gray-100 dark:bg-neutral-800 rounded-lg p-4">
            <div class="flex space-x-2">
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-2 h-2 bg-gray-400 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
        </div>
    `;
    messagesContainer.appendChild(div);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    return id;
}

// Remove typing indicator
function removeTyping(id) {
    const element = document.getElementById(id);
    if (element) element.remove();
}

// Update project data
function updateProjectData(updates) {
    Object.assign(projectData, updates);
    renderProjectSummary();
}

// Render project summary
function renderProjectSummary() {
    if (!projectData.title && !projectData.theme) {
        return;
    }
    
    let html = '';
    
    if (projectData.title) {
        html += `
            <div class="mb-4">
                <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Titre</label>
                <p class="text-sm font-medium text-gray-900 dark:text-white">${escapeHtml(projectData.title)}</p>
            </div>
        `;
    }
    
    if (projectData.theme) {
        html += `
            <div class="mb-4">
                <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Sujet</label>
                <p class="text-sm text-gray-700 dark:text-gray-300">${escapeHtml(projectData.theme)}</p>
            </div>
        `;
    }
    
    if (projectData.pillar) {
        html += `
            <div class="mb-4">
                <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Type</label>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-indigo-100 dark:bg-indigo-900 text-indigo-800 dark:text-indigo-200">
                    ${projectData.pillar}
                </span>
            </div>
        `;
    }
    
    if (projectData.platform) {
        html += `
            <div class="mb-4">
                <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Plateforme</label>
                <span class="inline-flex items-center px-2 py-1 rounded-full text-xs font-medium bg-purple-100 dark:bg-purple-900 text-purple-800 dark:text-purple-200">
                    ${projectData.platform}
                </span>
            </div>
        `;
    }
    
    if (projectData.segments.length > 0) {
        html += `
            <div class="mb-4">
                <label class="block text-xs font-semibold text-gray-500 dark:text-gray-400 uppercase mb-1">Segments</label>
                <p class="text-sm text-gray-700 dark:text-gray-300">${projectData.segments.length} segment(s)</p>
            </div>
        `;
    }
    
    projectSummary.innerHTML = html;
    actionButtons.classList.remove('hidden');
}

// Generate job
async function generateJob() {
    if (!confirm('G√©n√©rer le job de production avec ces param√®tres ?')) return;
    
    try {
        const response = await fetch('{% url "marketing:ai_generate_job" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCookie('csrftoken')
            },
            body: JSON.stringify({
                projectData: projectData,
                conversation: conversation
            })
        });
        
        const data = await response.json();
        
        if (data.success) {
            window.location.href = `/marketing/job/${data.jobId}/`;
        } else {
            alert('Erreur lors de la cr√©ation du job');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Erreur lors de la cr√©ation du job');
    }
}

// Edit project
function editProject() {
    // TODO: Allow editing project parameters
    alert('Modification en d√©veloppement');
}

// Reset conversation
function resetConversation() {
    if (!confirm('Recommencer la conversation ? Vos donn√©es actuelles seront perdues.')) return;
    
    conversation = [];
    projectData = {
        title: '',
        theme: '',
        pillar: '',
        platform: '',
        segments: [],
        assets: [],
        provider: 'luma',
        aspectRatio: '9:16'
    };
    uploadedAssets = [];
    
    messagesContainer.innerHTML = '';
    messagesContainer.appendChild(document.getElementById('welcome-message').cloneNode(true));
    projectSummary.innerHTML = '<div class="text-center py-8 text-gray-500 dark:text-gray-400"><p class="text-sm">Les informations de votre projet appara√Ætront ici.</p></div>';
    actionButtons.classList.add('hidden');
}

// Utility functions
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
</script>

<!-- CSRF Token for AJAX -->
{% csrf_token %}
{% endblock %}
